(function(g){Function.prototype.method=function(p,q){if(!this[p]){this.prototype[p]=q}return this};Function.prototype.methods=function(p){for(var q in p){this.method(q,p[q])}};var n={isIe:function(){return(navigator.userAgent.indexOf("MSIE")>-1)?true:false},isSafari:function(){return(navigator.userAgent.indexOf("AppleWebKit")>-1&&navigator.userAgent.indexOf("Chrome")===-1)}};var e={initializeSoundManager:function(){if(!soundManager){window.soundManager=new SoundManager();var p=window.soundManager;p.url="swf";p.wmode="transparent";p.useFastPolling=true;p.useHTML5Audio=true;if(n.isSafari()){soundManager.useHighPerformance=false}else{p.useHighPerformance=true}p.flashLoadTimeout=1000;p.beginDelayedInit()}},ieStuff:function(){if(!Array.prototype.indexOf){Array.prototype.indexOf=function(r,u){if(this===null){throw new TypeError()}var s=Object(this);var p=s.length>>>0;if(p===0){return -1}var v=0;if(arguments.length>0){v=Number(arguments[1]);if(v===NaN){v=0}else{if(v!==0&&v!==Infinity&&v!==-Infinity){v=(v>0||-1)*Math.floor(Math.abs(v))}}}if(v>=p){return -1}var q=v>=0?v:Math.max(p-Math.abs(v),0);for(;q<p;q++){if(q in s&&s[q]===r){return q}}return -1}}}};g.fn.SwaggPlayer=function(r){var s={};s.id=this.attr("id");if(s.id){if(!n.isIe()){if(console.time){console.time("SwaggPlayerStart")}}e.initializeSoundManager();e.ieStuff();if(soundManager){var q=g.extend(r,s),p=new f();p.init(q)}else{g.error("An error occured while initializing soundManager!")}}else{g.error("Swagg Player element missing id attribute!")}};var c=function(q){this.PLAYER=q;this.props={};this.callbacks={};this.consoleSupport=false;if(console){this.consoleSupport=true}};var b=function(r,q){this.PLAYER=r;this.log=r._config.consoleSupport;this.logging=r._config.props.logging||[];this.levelall=this.logging.indexOf("all")>-1;this.levelinfo=this.levelall===true?true:this.logging.indexOf("info")>-1;this.levelerror=this.levelall===true?true:this.logging.indexOf("error")>-1;this.levelapierror=this.levelall===true?true:this.logging.indexOf("apierror")>-1;this.levelwarn=this.levelall===true?true:this.logging.indexOf("warn")>-1;this.leveldebug=this.levelall===true?true:this.logging.indexOf("debug")>-1;this.id=q};b.methods({error:function(p){if(this.levelerror&&this.log){console.error("Swagg Player::"+this.id+"::Error::"+p)}},info:function(p){if(this.levelinfo&&this.log){console.log("Swagg Player::"+this.id+"::Info::"+p)}},warn:function(p){if(this.levelwarn&&this.log){console.warn("Swagg Player::"+this.id+"::Warning::"+p)}},debug:function(p){if(this.leveldebug&&this.log){console.warn("Swagg Player::"+this.id+"::Debug::"+p)}},apierror:function(p){if(this.levelapierror&&thims.log){console.error("Swagg Player::"+this.id+"::API Error::"+p)}}});var i=function(){};i.method("timeString",function(r){var q=parseInt(r,10),p=q>9?r:"0"+r;return p!=="60"?p:"00"});var d=function(q){this.player=q;q._logger.debug("SoundFactory Initiated")};d.methods({createSound:function(v){var w=this,u=w.player._html,s=w.player._config,q=w.player._data.songs,p=v.id;if(u.useArt===true&&v.thumb!==undefined){v.configureArt();v.image=new Image();v.image.src=v.thumb}if(!q[v.id]){w.player._data.songs.push(v)}var x=w.player._html.player+"-song-"+p.toString();var t=window.soundManager;t.callback=function(y){g.when(y.scope.player[y.first](y.sound)).done(function(z){y.scope.player.executeIfExists(y.next,y.sound,z)})};var r=t.createSound({id:x,url:v.url,autoLoad:s.props.eagerLoad||false,usePolicyFile:false,onplay:function(){var y=this;t.callback({scope:w,first:"_onplay",sound:this,next:"onPlay"})},onpause:function(){var y=this;t.callback({scope:w,first:"_onpause",sound:this,next:"onPause"})},onstop:function(){var y=this;t.callback({scope:w,first:"_onstop",sound:this,next:"onStop"})},onfinish:function(){var y=this;t.callback({scope:w,first:"_onfinish",sound:this,next:"onFinish"})},onresume:function(){var y=this;t.callback({scope:w,first:"_onresume",sound:this,next:"onResume"})},whileplaying:function(){var y=this;t.callback({scope:w,first:"_whileplaying",sound:this,next:"whilePlaying"})},whileloading:function(){var y=this;t.callback({scope:w,first:"_whileloading",sound:this,next:"whileLoading"})},onerror:function(){var y=this;t.callback({scope:w,first:"_onerror",sound:this,next:"onError"})}});r.id=x;r.repeat=w.player.internal.repeat;w.player._data.last_song=v.id;if(u.playList!==undefined&&u.playList===true){w.player.appendToPlaylist(r)}return r}});var j=function(p,r){var q;for(q in p){this[q]=p[q]}this.id=r};j.method("configureArt",function(p){this.image=new Image();this.image.src=p||this.thumb});var k=function(q){q._logger.debug("Data intializing");this.PLAYER=q;this.last_song=-1;this.songs=[];this.curr_sprite_class="";this.isIe=n.isIe();this.curr_song=-1;this.vol_interval=20;this.interval_id=-1};k.methods({processSongs:function(p){var w=this.PLAYER,r=new Array(),v=p.length,q=w._html,s=w._config;for(var u=0;u<v;u++){var t=new j(p[u],u);if(q.useArt===true&&p[u].thumb!==undefined){t.configureArt(p[u].thumb);p[u].image=new Image();p[u].image.src=p[u].thumb}r.push(t)}this.songs=r;this.last_song=this.songs.length-1},getSongs:function(){var q=this,r=this.PLAYER._config,p=r.props.data;if(typeof p==="string"){g.ajax({type:"GET",url:p,dataType:"json",success:function(s){q.processSongs(s);return null},error:function(v,s,t){var u="There was a problem fetching your songs from the server: "+t;q.PLAYER._logger.error(u);return u}});return null}else{this.processSongs(p);return null}}});var l=function(q){this.PLAYER=q;this.div=null;this.player=null;this.playlist=null;this.art=null;this.loading_indication=null;this.progress_wrapper=null;this.bar=null;this.loaded=null;this.song_info=null;this.controls_div=null;this.bridge_data=null;this.artist=null;this.title=null;this.useArt=false;this.playList=false;this.metadata={progressWrapperWidth:0}};l.methods({initHtml:function(p){this.PLAYER._logger.debug("Html initializing");this.player=p.id;this.playlist=g("#"+this.player+" .swagg-player-list");this.art=g("#"+this.player+" .swagg-player-album-art");this.loading_indication=g("#"+this.player+" img.swagg-player-loading");this.progress_wrapper=g("#"+this.player+" .swagg-player-progress-wrapper");this.bar=g("#"+this.player+" .swagg-player-bar");this.loaded=g("#"+this.player+" .swagg-player-loaded");this.song_info=g("#"+this.player+" .swagg-player-song-info");this.controls_div=g("#"+this.player+" .swagg-player-controls");this.artist=g("#"+this.player+" .swagg-player-artist");this.title=g("#"+this.player+" .swagg-player-title");this.user_art_css={height:0,width:0};this.useArt=(this.art.length>0);this.playList=(this.playlist.length>0)},setupProgressBar:function(){this.PLAYER._logger.debug("setting up progress bar");if(this.progress_wrapper.length>0){var s=g("#"+this.player+" div.swagg-player-progress-wrapper"),p=s.css("height"),r=g("<div></div>"),q=g("<div></div>");q.addClass("swagg-player-loaded").css("height",p).css("width",0).css("float","left").css("margin-left","0");s.append(q);this.loaded=g("#"+this.player+" div.swagg-player-loaded");r.addClass("swagg-player-bar").css("height",p).css("width",0).css("float","left").css("margin-left","auto");q.append(r);this.bar=g("#"+this.player+" div.swagg-player-bar");this.metadata.progressWrapperWidth=parseFloat(this.progress_wrapper.css("width"))}}});var h=function(q){this.PLAYER=q;this.play=null;this.skip=null;this.back=null;this.stop=null};h.methods({setup:function(r){var s=this.PLAYER,q=s._imageLoader;s._logger.debug("setting up controls");this.play=g("#"+s._html.player+" .swagg-player-play-button");this.skip=g("#"+s._html.player+" .swagg-player-skip-button");this.back=g("#"+s._html.player+" .swagg-player-back-button");this.stop=g("#"+s._html.player+" .swagg-player-stop-button");if(q.play!==null){this.play.css("cursor","pointer")}if(q.skip!==null){this.skip.css("cursor","pointer")}if(q.back!==null){this.back.css("cursor","pointer")}if(q.stop!==null){this.stop.css("cursor","pointer")}r.css("cursor","pointer")}});var o=function(q){this.PLAYER=q};o.methods({bindControllerEvents:function(){var r=this.PLAYER,y=r._controls,v=r._imageLoader,w=v.imagesLoaded,x=r._config.props.buttonHover||false,s=["play","back","stop","skip"],u,t,q;r._logger.debug("Binding controller button events");for(u=0;u<s.length;u++){t=s[u];if(t==="play"){q=function(){r.play(r._data.curr_song);return false}}else{if(t==="skip"){q=function(){r.skip(1);return false}}else{if(t==="stop"){q=function(){r.stopMusic(r._data.curr_song);return false}}else{if(t==="back"){q=function(){r.skip(0);return false}}}}}this.bindEvents({func:t,controls:y,images:w,usehover:x,imageLoader:v},q)}},bindEvents:function(u,s){var t=u.func,r=u.controls,q=u.images,p=u.imageLoader,v=u.usehover;r[t].bind({click:s,mouseover:function(){if(q===true&&v){var w=t+"Over";g(this).attr("src",p[w].src)}},mouseout:function(){if(q===true&&v){g(this).attr("src",p[t].src)}}})},bindMediaKeyEvents:function(){var r=this.PLAYER,q=r._data.curr_song;r._logger.debug("Binding media key events");g(document).keydown(function(p){if(!p){p=window.event}switch(p.which){case 179:r.play(q);return false;case 178:r.stopMusic(q);return false;case 176:r.skip(1);return false;case 177:r.skip(0);return false;case 175:r.volume(q,1);return false;case 174:r.volume(q,0);return false;default:return false}})},setupSeek:function(){var r=this.PLAYER,q=r._html;r._logger.debug("setting up seek events");q.loaded.css("cursor","pointer").bind({click:function(y){var p=q.player+"-song-"+r._data.curr_song,B=q.metadata.progressWrapperWidth,s=soundManager.getSoundById(p),A=y.pageX-q.loaded.offset().left,z=s.bytesLoaded/s.bytesTotal,u=r.getDuration(s),w=A/B,v=B*z,t=Math.round(w*u);if(t<s.bytesLoaded){s.setPosition(t);r.progress(s)}}});q.loaded.bind("mouseover hover mousemove",function(z){var p=q.player+"-song-"+r._data.curr_song,w=r._config,s=soundManager.getSoundById(p),B=z.pageX-q.loaded.offset().left,A=this,v=r.getDuration(s),y=B/q.metadata.progressWrapperWidth,u=Math.round(y*v),t=r.millsToTime(u,1);r.executeIfExists("onSeekPreview",this,[z,t])});q.loaded.bind("mouseout",function(p){r.executeIfExists("onSeekHide",this,[p])})}});var m=function(q){this.PLAYER=q;this.play=null;this.playOver=null;this.pause=null;this.pauseOver=null;this.stop=null;this.stopOver=null;this.back=null;this.backOver=null;this.skip=null;this.skipOver=null;this.art=null;this.imagesLoaded=false};m.methods({setup:function(){this.PLAYER._logger.debug("setting up image loader");var p=this.PLAYER._config.props;if(p.buttonsDir!==undefined){this.PLAYER._controls.setup(this.PLAYER._html.controls_div);this.loadButtonImages(p.buttonsDir)}else{p.buttonHover=false}if(p.spriteImg!==undefined){this.art=new Image();this.art.src=p.spriteImg}},loadButtonImages:function(p){var r=this.PLAYER,s=r._config.props.buttonHover||false,q=r._controls;r._logger.debug("Loading images for controls");if(q.play.length>0){this.play=new Image();this.play.src=p+"play.png";this.pause=new Image();this.pause.src=p+"pause.png";if(s===true){this.playOver=new Image();this.playOver.src=p+"play-over.png";this.pauseOver=new Image();this.pauseOver.src=p+"pause-over.png"}}if(q.skip.length>0){this.skip=new Image();this.skip.src=p+"skip.png";if(s===true){this.skipOver=new Image();this.skipOver.src=p+"skip-over.png"}}if(q.back.length>0){this.back=new Image();this.back.src=p+"back.png";if(s===true){this.backOver=new Image();this.backOver.src=p+"back-over.png"}}if(q.stop.length>0){this.stop=new Image();this.stop.src=p+"stop.png";if(s===true){this.stopOver=new Image();this.stopOver.src=p+"stop-over.png"}}this.imagesLoaded=true;this.PLAYER._logger.info("Images Loaded.")}});var f=function(){this._logger=null;this._data=null;this._html=null;this._config=null;this._events=null;this._controls=null;this._imageLoader=null;this._swaggPlayerApi=null};f.methods({init:function(p){var q=this;q.initComponents(p);if(!soundManager.createSongs){soundManager.createSongs=function(A){q._logger.info("createSongs()");var w=q._data,r=w.songs;if(w.songs[0]!==undefined){var t=q._config,z=q._html,y=new d(q),B,x;for(var v=0,u=r.length;v<u;v++){B=r[v];x=y.createSound(B)}A.apply(this,[q])}else{q._logger.error("No Songs!!")}}}soundManager.onload=function(){soundManager.createSongs(function(r){var t=r._html,u=r._data,v=u.songs[0],s=r._config;t.loading_indication.remove();u.curr_song=0;if(t.useArt===true){r._logger.info("Intializing album art...");r.setAlbumArtStyling(0)}r._events.setupSeek();if(s.props.autoPlay!==undefined&&s.props.autoPlay===true){setTimeout(function(){r.play(u.curr_song)},1000)}q.executeIfExists("onSetupComplete",this,[q._swaggPlayerApi,v]);if(!n.isIe()){if(console.timeEnd){console.timeEnd("SwaggPlayerStart")}}r._logger.info("Swagg Player ready!")})};soundManager.onerror=function(){q._logger.error("An error has occured with loading Sound Manager! Rebooting.");soundManager.flashLoadTimeout=0;soundManager.url="swf";setTimeout(soundManager.reboot,20);setTimeout(function(){if(!soundManager.supported()){var r="Something went wrong with loading Sound Manager. No tunes for you!";_logger.error("Something went wrong with loading Sound Manager. No tunes for you!");this.executeIfExists("onErrorComplete",onError,[r])}},1500)}},initComponents:function(q){var p=this;this._config=new c(this);this._config.props=g.extend(this._config.props,q);this._logger=new b(this,q.id);this._logger.info("initializing swagg player components");this._data=new k(this);this._html=new l(this);this._html.initHtml(q);g.when(this._data.getSongs()).done(function(r){if(r){this.executeIfExists("onError",this,[])}else{p._html.setupProgressBar();p.setupApi();p._controls=new h(p);p._imageLoader=new m(p);p._imageLoader.setup();if(q.buttonsDir!==undefined){p._controls.setup(p._html.controls_div)}else{q.buttonHover=false}if(q.spriteImg!==undefined){p._imageLoader.art=new Image();p._ImageLoader.art.src=q.spriteImg}p._events=new o(p);p._events.bindControllerEvents();p._events.bindMediaKeyEvents();if(!soundManager.supported()){p._logger.warn("Support for SM2 was not found immediately! A reboot will probably occur. We shall see what happense after that.")}else{p._logger.info("SM2 support was found! It SHOULD be smooth sailing from here but hey, you never know - this web development stuff is tricky!")}}})},_whileplaying:function(t){this.progress(t);var s=t.loaded===true?t.duration:t.durationEstimate,r=this.millsToTime(t.position),q=this.millsToTime(s),p={currTime:r,totalTime:q};return[p]},_onplay:function(r){var q=this._data,s=q.songs[q.curr_song],p={},t;for(t in s){if(t!="id"&&g.isFunction(s[t])===false){p[t]=s[t]}}this.playPauseButtonState(0);if(this.loaded(r)===true){this.fillLoaded()}return[p]},_onpause:function(p){this.playPauseButtonState(1);return[]},_onstop:function(p){this.playPauseButtonState(1);return[]},_onfinish:function(r){if(this.internal.repeatMode===false){var s=parseInt(r.id.split("-")[3],10),p=null,q=this._data.songs.length-1;if(s<q){this.skip(1)}else{this.stopMusic(s);p=[]}}else{this.repeat()}return p},_onresume:function(p){this.playPauseButtonState(0);return[]},_whileloading:function(q){var p=this.whileLoading(q).toFixed(2)*100;return[Math.round(p)]},_onerror:function(p){var q="An error occured while attempting to play this song. Sorry about that.";this._logger.error(q);return[q]},executeIfExists:function(s,r,q){var p=this._config;if(p.props[s]&&g.isFunction(p.props[s])){p.props[s].apply(r,q)}},getDuration:function(p){var q;if(!p.loaded===true){q=p.durationEstimate}else{q=p.duration}return q},repeat:function(p){var q=_html.player+"-song-"+_data.curr_song,r=soundManager.getSoundById(q);this._logger.info("repeat()");this.resetProgressBar();r.setPosition(0);r.play()},play:function(p){var q=this._html.player+"-song-"+p,r,s=soundManager.getSoundById(q);this._logger.debug("Playing track: "+q);if(s.paused===true){this._logger.debug("Unpausing song");s.resume()}else{if(s.playState===1){this._logger.info("Pausing current track");s.pause()}else{r=true;this._logger.info("Playing current track from beginning");s.play()}}return r},setupApi:function(){this._logger.debug("setting up api");this._swaggPlayerApi=new a(this);this.internal.player=this},appendToPlaylist:function(r){var x=this,u=r.id.split("-")[3],t=this._data.songs[parseInt(u,10)],v=this._html,q="item-"+t.id,p=g("<li></li>");this._logger.debug("appending to playlist: "+t.title);p.attr("id",q);p.addClass("swagg-player-playlist-item");p.html(t.title+" - "+t.artist);p.css("cursor","pointer");p.data("song",t);var s=this._config.props.playListListeners||{};var w=g.extend({},s,{click:function(){x.stopMusic(x._data.curr_song);var y=parseInt(g(this).data("song").id,10),z=function(){x.play(y)};x._data.curr_song=y;if(v.useArt===true){x.switchArt(y,z)}else{x.play(y)}return false}});p.bind(w);v.playlist.append(p)},playPauseButtonState:function(s){var q=this._imageLoader.imagesLoaded,p,u,t=this._controls.play,r=this._config.props.buttonHover||false;if(s===1){if(q===false){t.html("play ")}else{p=this._imageLoader.play.src;if(r===true){u=this._imageLoader.playOver.src}}}else{if(s===0){if(q===false){t.html("pause ")}else{p=this._imageLoader.pause.src;if(r===true){u=this._imageLoader.pauseOver.src}}}else{this._logger.error("Invalid button state! : "+s)}}if(q===true){t.attr("src",p);if(r===true){t.bind({mouseout:function(){t.attr("src",p)},mouseover:function(){t.attr("src",u)}})}}},skip:function(s){var r=this._data,q=this._html,p=r.curr_song;this._logger.info("skip()");if(s===1){if(p<r.songs.length){if(p==r.songs.length-1){p=0}else{p=p+1}}}else{if(s===0){if(p===0){p=r.songs.length-1}else{p=p-1}}else{this._logger.error("Invalid skip direction flag: "+s)}}this.stopMusic(p);r.curr_song=p;if(this._html.useArt===true){this.executeIfExists("onBeforeSkip",this,[]);this.switchArt(p)}else{this.play(p)}},jumpTo:function(p){this._logger.debug("jumping to track "+p);this.stopMusic(p);this._data.curr_song=p;if(this._html.useArt===true){this.executeIfExists("onBeforeSkip",this,[]);this.switchArt(p)}else{this.play(p)}},wipeArtCss:function(){var p=this._html.art;p.removeClass(this._data.curr_sprite_class);p.css("height","");p.css("width","");p.css("background-image","");p.css("background","")},resetProgressBar:function(){this._html.bar.css("width",0);this._html.loaded.css("width",0)},stopMusic:function(p){this._logger.debug("stopping music");this.playPauseButtonState(1);this.resetProgressBar();soundManager.stopAll()},volume:function(q,p){var s=me._html.player+"-song-"+q,t=soundManager.getSoundById(s),r=t.volume;if(p===1){this._logger.debug("increasing volume");soundManager.setVolume(s,r+this._data.vol_interval)}else{if(p===0){self._logger.debug("decreasing volume");soundManager.setVolume(s,r-this._data.vol_interval)}else{this._logger.error("Invalid volume flag!")}}},setAlbumArtStyling:function(p){var v=this._html.art,t=this._data,u=t.songs[p],s=t.songs,q=this._config,r=this._html;this.wipeArtCss();if(u.spriteClass!==undefined){v.addClass(u.spriteClass);t.curr_sprite_class=u.spriteClass}else{v.css("background"," transparent url("+s[p].image.src+")")}},switchArt:function(p){var r=this,q=this._html.player+"-song-"+p,w=this._html.art,s=this._config,u=this._data,t=u.songs,v=t[p];r._logger.info("Will show  for song at index: "+p);if(g.ui){w.hide("slide",200,function(){r.wipeArtCss();r.setAlbumArtStyling(p);g(this).show("slide",function(){r.play(p);r.executeIfExists("onAfterSkip",r,[])})})}else{w.fadeOut("fast",function(){r.wipeArtCss();r.setAlbumArtStyling(p);g(this).fadeIn("fast",function(){r.play(p);r.executeIfExists("onAfterSkip",r,[])})})}},fillLoaded:function(){this._html.loaded.css("width",this._html.metadata.progressWrapperWidth)},loaded:function(p){if(p.loaded===true&&p.readyState===3&&p.bytesLoaded===p.bytesTotal){return true}else{return false}},whileLoading:function(s){var u=s.position,r=s.bytesLoaded/s.bytesTotal,t=s.duration;var p=this._html.metadata.progressWrapperWidth,q=p*r;this._html.loaded.css("width",q);return r},progress:function(s){var w=s.position,v=0,q=s.bytesLoaded/s.bytesTotal;if(s.loaded===false){v=s.durationEstimate}else{v=s.duration}var u=w/v,p=this._html.metadata.progressWrapperWidth,r=p*u;this._html.bar.css("width",r)},millsToTime:function(s,q){var p=new i(),t=Math.floor(s/1000),r=0;if(t>60){r=Math.floor(t/60);t=Math.round(t%60)}if(t===60){r+=1;t=0}return{mins:p.timeString(r),secs:p.timeString(t)}},internal:{player:null,repeatMode:false}});var a=function(p){var q=this;q.playback={setRepeat:function(r){p.internal.repeatMode=(r===true||r===false)?r:false;return q},inRepeat:function(){var s=internal.repeat;return(s===true||s===false)?s:false},volUp:function(){p.volume(p._data.curr_song,1);return q},volDown:function(){p.volume(p._data.curr_song,0);return q},playTrack:function(r){var s=r-1;if(s<=(_data_.last_song)&&s>=0){p.jumpTo(r-1)}else{_logger.apierror("Invalid track number '"+r+"'")}return q},stop:function(){p.stopMusic(null)},addTracks:function(z){var x=p.PLAYER,u=new d(p),w,r,y,v;if(g.isArray(z)){for(v=0;v<z.length;v++){w=p._data.last_song;r=new j(z[v],w+1);y=u.createSound(r)}}else{w=p._data.last_song;r=new j(z,w+1);y=u.createSound(r)}}}}})(jQuery);